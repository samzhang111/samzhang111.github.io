---
layout: post
title: ansible
date: 2015-10-06 21:34:00
---

{{page.title}}
==============
{{page.date}}

This is a collection of the gotchas! that I encountered while working with
[Ansible](https://github.com/ansible/ansible), a nifty "IT automation"
platform. I guess it's nifty now, now that I can claim to have used it
without dying. The me that sat in the Workshop Cafe staring in frustration
at my "playbooks" (nothing is more frustrating than debugging pieces of
yaml) can just keep spinning his tires in history because I am so much
smarter than him now. Just kidding. That is why I keep these blogs --
because it is ridiculous how different it feels to have solved a problem,
and to be working on it.

###Bug 1.

I made a typo in my Ansible "playbook" (as the configuration files are
called), copying over from an example. Of course, I didn't _know_ I made
a typo, but I figured as much when I would run my playbook and it would
say, `msg: dictionary requested, could not parse JSON or key=value`. I
couldn't figure out which key was unparsable though.

So I snuck my way into Ansible on my local filesystem (for me, at
`/usr/local/lib/python2.7/dist-packages/ansible`, which you can
find with `pip show ansible` or something bizarrely misguided like
[pyw](https://github.com/samzhang111/pyw)). I found the [line](https://github.com/idano/home/blob/master/lib/ansible/module_utils/basic.py#L694) that
emitted that error, and modified it to also print out which value was
wrong. This helped me track down my problem, which was that instead of writing:

```
instance_tags:
  Name: college-scraper
  Environment: college-scraper
```

I had

``` 
instance_tags: college-scraper 
```

This bug took approximately an hour of my time. I submitted a [Github
issue](https://github.com/ansible/ansible/issues/12624) about making the
error more verbose. Once it was approved, I downloaded the repo, spent
another hour syncing up my development environment to pass Ansible's tests
locally (I ended up just installing their test requirements globally),
and then discovered that the problem was already solved by the 2.0.0 release.
The version of Ansible I acquired from pip was version 1.9.3. Bah, humbug.

**Time I could have spent on lepidoptery instead: 2 hours.**

###Bug 2

I wanted to split a text file across my hosts, with each host receiving a unique fractoin of lines.

My first thought was: is there an incrementing integer for each of my hosts? If so, I can break my
file up, with incrementing numeric suffixes for the total number of hosts, then copy them over
using the host index.

Then I backtracked and wondered whether there was a magic file partitioning module in Ansible itself.

Bug-hunting is hairiest when it is really a semantic problem. I didn't
know how to frame the thing I was looking for, and besides, there
were multiple ways of doing the same thing (but no way that I knew
how). Ansible comes off as such a radically innovative IT orchestration
tool that I found myself wondering, "Is my feature really
the wrong way of thinking about this?" Maybe Ansible has risen above
the mere loop, and eschews the plebian attachment of an enumerator
index to its _parallelized_ hosts.

In a way, I had an overabundance of choice about how to proceed. I went down a few
dead-ends. For example, I started reading about how it was possible to access
the hosts in an array. That wouldn't be too helpful for me, because modifying that array
does nothing to the overall looping of hosts.

The other dead-end was that the Ansible templating syntax contains a way to
loop over an array _with an index_. That was extraordinarily tempting to me, since 
in my mind I am thinking about Python's `enumerate`, and how nice it would
be to just have the enumerated version of the host loop.

However, the same issue exists: any array I had access to was different than "the host loop" itself.
But is there even such a thing as "the host loop"? It goes back to that issue of semantics,
especially with a project that you're not that familiar with. People come up with all sorts of
pet names for their projects's components, and it takes a lot of familiarity just to know
what to call something. These sorts of decisions are very important to a project.

Anyway, it turns out [EC2 hosts maintain an ami_launch_index property
themselves](http://stackoverflow.com/questions/32929823/partitioning-data-across-hosts-in-ansible-access-index-of-host-in-task).
I even figured out how to access the variable, sort of just by fumbling
around.  It's an amazing phenomenon to me how asking a question out loud
will often cause me to think of the answer myself right away. I'd like
to see a study about that.

**Time I could have spent reading about water on Mars: 2 hours**

**Total time I could have been wandering the woods in thought: 4 hours**
